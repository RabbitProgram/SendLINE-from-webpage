#! /opt/alt/python37/bin/python3.7
# -*- coding: utf-8 -*-

import random
import requests
import cgi
import os
import sys
import io
import datetime
from decimal import Decimal, ROUND_HALF_UP, ROUND_HALF_EVEN
import urllib.parse
import json
# from geolite2 import geolite2


# å‚è€ƒã‚µã‚¤ãƒˆ
# ãƒ»Pythonã§LINEã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹ï¼šhttps://qiita.com/moriita/items/5b199ac6b14ceaa4f7c9
# ãƒ»Python CGIã§ã‚¢ã‚¯ã‚»ã‚¹æƒ…å ±å–å¾—ï¼šhttps://webings.net/python/referer/
# ãƒ»ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¸€è¦§ï¼šhttps://www.futomi.com/lecture/env_var/index.html
# ãƒ»IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰ä½ç½®æƒ…å ±å–å¾—ï¼šhttps://euniclus.com/article/get-location-information/


# LINEãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ï¼ˆã“ã“ã‹ã‚‰ï¼‰
class LINENotifyBot:
    API_URL = 'https://notify-api.line.me/api/notify'
    def __init__(self, access_token):
        self.__headers = {'Authorization': 'Bearer ' + access_token}

    def send(
            self, message,
            image=None,image_row=None, sticker_package_id=None, sticker_id=None,
            ):
        payload = {
            'message': message,
            'stickerPackageId': sticker_package_id,
            'stickerId': sticker_id,
            }
        files = {}
        if image != None:
            files = {'imageFile': open(image, 'rb')}
        if image_row != None:
            files = {'imageFile': image_row}
        r = requests.post(
            LINENotifyBot.API_URL,
            headers=self.__headers,
            data=payload,
            files=files,
            )


# æ•°å€¤å‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’èª¿ç¯€ã—ãŸæ–‡å­—åˆ—å‹ã«ç½®ãæ›ãˆã‚‹
# sizeï¼šãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºï¼ˆå˜ä½ï¼šãƒã‚¤ãƒˆï¼‰ã€roundcountï¼šå°æ•°ç¬¬ä½•ä½ã¾ã§è¡¨ç¤ºã™ã‚‹ã‹
def size_to_str(size,roundcount):
    unit=["Byte","KB","MB","GB","TB"]  # å˜ä½
    changecount=0  #å˜ä½ã‚’å¤‰æ›´ã—ãŸå›æ•°

    # èª¿ç¯€
    while(changecount<len(unit)-1):
        if(size/1024>1):
            size=size/1024
            changecount+=1
        else:
            break
    
    # å››æ¨äº”å…¥
    if(roundcount==0):
        dec="1"
    else:
        dec=str(1/(10**roundcount))
    size=Decimal(str(size)).quantize(Decimal(dec), rounding=ROUND_HALF_UP)
    return str(size)+" "+unit[changecount]


# çµµæ–‡å­—ä¸€è¦§ï¼šhttps://note.com/kawatyanlife/n/ndf5e32d8dcd6
emoji=["âœ¨","ğŸ˜Š","â˜ºï¸","ğŸ’¦","â€¼ï¸","ğŸ˜…","â—ï¸","ğŸ˜­","ğŸ’•","â¤ï¸","ğŸ˜‚","â­ï¸","ğŸ‘","â™‚","â™€","ğŸ™‡","ğŸ˜Œ","ğŸ˜†","â–¶ï¸","ğŸ‘‹","ğŸ’–","ğŸ˜","âœ…","ğŸ¤”","ğŸ¤£","â‰ï¸","ğŸ”¥","ğŸ¥º","ğŸ€","ğŸ™","â£ï¸","ğŸŒŸ","ğŸ˜¢","â˜€ï¸","ğŸŒˆ","ğŸ»","âœŒï¸","ğŸµ","ğŸ’ª","â™¥ï¸","â¬‡ï¸","ğŸ¥°","ğŸŒ¸","ğŸ‘‡","ğŸ˜ƒ","ğŸ¤—","ğŸ™Œ","ğŸ˜±","ğŸ˜„","ğŸ˜‰","ğŸ’“","â“","ğŸ‘","ğŸ˜","ğŸ‘€","ğŸ‰","ğŸ˜³","ğŸ˜‹","ğŸ’¡","ğŸ¶","ğŸŒ±","ğŸ’›","âœ³ï¸","ğŸŒ™","âœ–ï¸","â¡ï¸","ğŸ˜“","ğŸ˜‡","ğŸ™†","ğŸ’§","â˜•ï¸","ğŸ","ğŸ˜€","ğŸ™„","âœï¸","ğŸ’¢","ğŸ˜","âœ”ï¸","ğŸ§¡","âœ‹ï¸","ğŸŒ»","ğŸŒ·","ğŸ¶","ğŸ’«","âš¡ï¸","âš ï¸","ğŸ’—","ğŸ™‹","ğŸŒ","ğŸŒ¼","â—¼ï¸","ğŸ‡","ğŸ’","ğŸ¾","Â®","ğŸ’¨","ğŸ’­","ğŸ“š","â˜ï¸","ğŸ‘Œ","âœ´ï¸","âœï¸","ğŸ˜¥","ğŸ˜£","ğŸ¯","ğŸ˜","ğŸ˜ª","ğŸ˜¤","ğŸ°","âœ‚ï¸","ğŸ¤¤","ğŸ¥³","ğŸŒ¿","ğŸ“","ğŸ°","ğŸ˜","â¬","ğŸ","ğŸ’™","ğŸ˜¨","ğŸ“–","âœŠï¸","ğŸ’","â˜”ï¸","ğŸ","ğŸƒ","ğŸ™‚","ğŸ¼","ğŸ˜","ğŸ˜°","â¤´ï¸","ğŸˆ","â•","â˜ï¸","ğŸŸ","ğŸ’°","ğŸ•Š","ğŸ‘‰","âš«ï¸","ğŸ’¤","ğŸ§˜","â—¾ï¸","ğŸ’","ğŸ˜”","ğŸ“·","ğŸŠ","ğŸ˜´","ğŸ˜µ","Â©","ğŸ‡º","ãŠ—ï¸","ğŸ˜«","ğŸ¥","ğŸ‘¨","â„¢","ğŸˆ","ğŸš","ğŸŒº","ğŸ‘Š","ğŸ•","ğŸ‘¼","ğŸ˜¡","ğŸ‚","ğŸ“¸","ğŸ‘©","ğŸ“","â¤µï¸","ğŸ¥•","ğŸ’Œ","ğŸ˜š","âŒ","ğŸ˜˜","ğŸº","âœˆï¸","â–ªï¸","ğŸ’š","ğŸ‘¶","ğŸ‘†","ğŸš¶","ğŸ’¥","ğŸ¦","ğŸ»","ğŸ™ƒ","ğŸŒ•","â™¨ï¸","ğŸ‘","ğŸ‚","ğŸ±","ğŸ’®","ğŸš","ğŸ¦€","â˜‘ï¸","ğŸ¤¦","ğŸƒ","â¬†ï¸","ğŸ","â­•ï¸","ğŸŒŠ","ğŸ’»","ğŸ™…","ğŸ˜²","ğŸ‹","ğŸ‡¦","ğŸœ","ğŸ§","ğŸ”¸","ğŸ‡","ğŸŒ¹","ğŸ™","â—€ï¸","ğŸ“…","ğŸŒ","ğŸ›","ğŸ®","ğŸ’œ","ğŸ’","ğŸ˜©","â™¦ï¸","ğŸ”¬","ğŸ“»","ğŸ¨","ğŸ’","ğŸ–","ğŸ§¸","ğŸ˜œ","ğŸ…","ğŸŒ","ğŸ´","âš”ï¸","ğŸ¦™","ğŸ˜‘","ğŸŒ€","â™»ï¸","ğŸ§€","ğŸ£","ğŸŒ¾","ğŸµ","ğŸ","ğŸš—","ğŸ¨","âœ‰ï¸","ğŸŒ°","ğŸ¤¸","ğŸ¥š","ğŸ”š","ğŸ£","ğŸ‘—","ğŸ¥€","ğŸ’","ğŸƒ","ğŸ´","ğŸŠ","ğŸ˜®","ğŸ¯","ğŸ¤","ğŸ“£","ğŸ¥£","ğŸ¤","ğŸŒ ","ğŸ˜–","ğŸ€","ğŸ“•","ğŸ‡µ","ğŸ’”","ğŸ¤","ğŸ¥","ğŸšƒ","ğŸ‰","ğŸ®","â˜˜ï¸","ğŸ»","âšªï¸","ğŸ¸","â›©","ğŸ”","ğŸ™ˆ","ğŸ‡¸","ğŸ","ğŸ‘§","ğŸ˜¸","ğŸ½","ğŸ˜¯","ã€°","ğŸ˜™","ğŸ³","ğŸ«","ğŸ¹","ğŸ","ğŸŒƒ","ğŸ‡¯","ğŸ”»","ğŸ•","ğŸ¥—","ğŸŒ","ğŸ˜·","ğŸ˜¿","ğŸ•º","â”","ğŸ«","ğŸ’¼","ğŸ“º","ğŸ©","ğŸ‡¹","ğŸ’©","ğŸ ","ğŸ¢","ğŸ¬","ğŸ’¯","âš½ï¸","ğŸ¦‹","ğŸ’","ğŸ‘¦","ğŸ–","ğŸ§š","ğŸŒ´","ğŸ¤·","ğŸ·","ğŸ·","ğŸ„","ğŸ¤™","ğŸŒ„","ğŸ‡®","ğŸ¤“","ğŸ˜º","ğŸ‹","ğŸ‡³","ğŸ“±","ğŸ¥”","ğŸ˜ ","ğŸˆ","ğŸ¤³","ğŸš²","ğŸ‘»","ğŸ‡·","ğŸ¦","ğŸŸ","ğŸ ","ğŸ’Ÿ","ğŸ¤","ğŸ¥´","ğŸ˜»","ğŸ§","ğŸ”","ğŸ‘‘","ğŸ–¤","ğŸ‡«","ğŸ˜¶","ğŸ–‹","ğŸ¼","â†”ï¸","ğŸ’ƒ","ğŸ’¸","ğŸ‡¨","ğŸ¥","ğŸ„","ğŸ“","ğŸ¿","ğŸ¸","ğŸ™","ğŸ§ ","ğŸ","â•","â˜ ï¸","â˜ªï¸","ğŸ”","ğŸš¤","ğŸ¥¶","ğŸ±","ğŸ¥±","ğŸ”","â„ï¸","ğŸ¥","ğŸ€„ï¸","ğŸšŒ","ğŸ¦„","ğŸ¥‡","ğŸ¥","ğŸ¥¤","ğŸŒ‚","ğŸ¤","ğŸ‘","ğŸ˜¹","ãŠ™ï¸","ğŸ†","ğŸ¦Œ","ğŸª","ğŸ’‰","ğŸ’‹","ğŸŒ","âš¾ï¸","â™£ï¸","ğŸ‘¬","ğŸš€","ğŸ","ğŸ¦¦","ğŸ’£","ğŸ˜½","ğŸ†","â™ ï¸","ğŸ‘¹","ğŸ¦–","ğŸ‘","ğŸ¦","ğŸ¥‘","ğŸµ","ğŸ¡","ğŸ‘ˆ","â˜ï¸","ğŸ˜›","âš•","ğŸ‰","ğŸ’Š","ğŸ‘µ","ğŸŒ¤","ğŸ§","â‡ï¸","ğŸ¶","ğŸ‘ª","ğŸ£","ğŸ¥¯","ğŸŒ²","ğŸŒ³","ğŸ¥","ğŸ","ğŸ¥","ğŸ¦Š","ğŸ‘½","ğŸ˜","ğŸŒ›","ğŸ¡","ğŸš™","â˜‚ï¸","ğŸ’˜","ğŸ—“","ğŸ§™","ğŸ²","ğŸŒœ","ğŸ¬","ğŸ","ğŸ˜ˆ","ğŸ¾","ğŸ”°","ğŸ§","ğŸ“¹","ğŸ ","ğŸŠ","ğŸ—»","ğŸ¹","ğŸ¹","ğŸ§’","ğŸ‘","ğŸ¼","â—»ï¸","ğŸ“’","ğŸ¦œ","ğŸ‘","ğŸ˜Ÿ","â˜¹ï¸","ğŸ•","ğŸ˜","ğŸŒ½","ğŸ—","ğŸ¤","ğŸ¦","ğŸ¦‘","ğŸ¥–","ğŸ˜—","ğŸ¥®","ğŸš´","ğŸ¤š","ğŸ“","ğŸ‡°","ğŸ‘‚","ğŸ’‡","ğŸ‘£","ğŸ’…","ğŸ‡","ğŸ‡¬","ğŸŒ†","ğŸ›Œ","ğŸ¥µ","ğŸ¦·","ğŸ¡","ğŸ¥Ÿ","ğŸ˜§","ğŸ”³","ğŸ·","ğŸ§¹","ğŸ¥¦","ğŸ½","ğŸ€","ğŸ…","ğŸ¥œ","ğŸŒª","âš“ï¸","ğŸ†–","ğŸ‡ª","ğŸ¥‚","ğŸ§","ğŸ“˜","ğŸ”–","ğŸ¦ ","ğŸ“","ğŸŒ¶","ğŸ“²","ğŸš©","â™¾","â˜¯ï¸","ğŸ¥©","ğŸ’ˆ","ğŸ‰","ğŸ„","ğŸ¦§","ğŸ¦’","â†˜ï¸","ğŸ˜","ğŸ¥Š","â†—ï¸","ğŸ™","ğŸ‘¸","ğŸ¤§","ğŸŒµ","ğŸ’´","ğŸ¢","ğŸ¦µ","ğŸ™€","ğŸœ","â˜ƒï¸","ğŸ˜","ğŸ¦¥","ğŸ¡","ğŸ¥¢","ğŸš•","ğŸ­","ğŸ‘®","ğŸ‡­","ğŸ¥›","ğŸ¨","ğŸ™","ğŸ¥“","ğŸ“—","ğŸ¤","ğŸ¤¢","ğŸš»","ğŸ”ª","ğŸŒ","ğŸ”½","ğŸƒ","ğŸ","ğŸ‘“","ğŸ¥ˆ","ğŸ¤‘","ğŸ”","âŒšï¸","ğŸ’€","ğŸ¬","ğŸ—’","ğŸ","ğŸ˜¦","ğŸ‘­","ğŸ¥’","ğŸ›€","ğŸ¦†","â¬›ï¸","ğŸ–¼","ğŸ®","ğŸ¦ª","ğŸ§…","ğŸ‡²","ğŸ”¹","ğŸ’ ","ğŸ“¦","ğŸ¤˜","ğŸ¾","ğŸ—¿","ğŸš¿","ğŸ¦”","ğŸ‘•","ğŸ¦¢","â–«ï¸","ğŸš","ğŸ˜’","ğŸ¤°","ğŸ¸","âš™ï¸","â°","ğŸ’","ğŸ›","ğŸ","ğŸ”®","âœ’ï¸","ğŸ›£","ğŸ•°","ğŸ•·","ğŸ”µ","ğŸ’¬","ğŸ›µ","ğŸš¢","ğŸ“”","â¬…ï¸","ğŸ‡§","ğŸ¤œ","ğŸ","ğŸ†—","ğŸ‘¾","ğŸ¥¬","ğŸ©","ğŸ˜•","ğŸ–","ğŸ§‘","ğŸ”¶","ğŸ","ğŸ”¯","â™“ï¸","ğŸ‘–","ğŸ¦²","ğŸ›","â›…ï¸","ğŸ‡¾","ğŸ””","ğŸ•¯","âŒ›ï¸","ğŸ”„","ğŸ²","ğŸ’„","ğŸ‘«","â—","ğŸ§²","ğŸ†š","ğŸ„","â±","ğŸ¨","ğŸ‘ƒ","ğŸ¥ª","ğŸº","ğŸ§–","ğŸ¯","ğŸ³","ğŸš¬","ğŸ°","âœ¡ï¸","ğŸŒ","â©","ğŸ¤›","ğŸ¦","ğŸŒ§","ğŸŒ©","â›°","ğŸ›","ğŸšª","ğŸ‹","ğŸ¦©","â™ï¸","ğŸŸ¦","ğŸ","ğŸ°","ğŸ’¿","ğŸ‡©","ğŸ”‘","ğŸŒ‘","ğŸ”","ğŸ—£","ğŸ“","ğŸ–Š","ğŸŒ‡","ğŸ‘¿","ğŸ—¼","ğŸ‘´","ğŸ•´","ğŸ‘°","ğŸ§ˆ","â›´","ğŸ™","ğŸ‡±","ğŸ­","ğŸš£","ğŸ§³","â˜„ï¸","â™‘ï¸","ğŸŸ¡","ğŸ¥§","â›³ï¸","ğŸ¦","ğŸ‘¯","ğŸ¦ˆ","ğŸ”—","ğŸš˜","ğŸ“†","ğŸ¤","ğŸš’","ğŸš¨","ğŸª","ğŸ¦®","ğŸ›«","ğŸšº","ğŸ§Š","ğŸŒ","ğŸ¦›","ğŸ‘›","â›ºï¸","ğŸ™","ğŸš‚","ğŸ½","â¬œï¸","ğŸ’µ","â–","ğŸ¢","â™‹ï¸","ğŸ‘º","ğŸ”¨","ğŸ”´","ğŸŸ¢","ğŸ›","ğŸ–","ğŸª","ğŸ","ğŸ‘","ğŸ˜¾","ğŸ‘ ","ğŸ§‚","ğŸŒ‹","ğŸ§¶","ğŸ‘…","ğŸ”…","ğŸ­","ğŸŒŒ","ğŸ³","ğŸ ","ğŸ¤¿","ğŸš‘","ğŸ§Ÿ","ğŸ¾","â³","ğŸŒ”","ğŸ¥­","ğŸª","ğŸ’’","ğŸ§±","ğŸŒ–","ğŸ","ğŸ™Š","â†ªï¸","ğŸšš","ğŸ“™","ğŸŸ©","ğŸŒ‰","ğŸŒ…","ğŸ“Š","ğŸš“","ğŸ§½","ğŸ˜¬","ğŸ","ğŸ”º","ğŸ—¾","ğŸ—","ğŸ“ˆ","ğŸ²","ğŸ¦³","ğŸ©","ğŸ¤–","ğŸµ","â›µï¸","ğŸ…±ï¸","ğŸ’","ğŸ¦","â›„ï¸","ğŸ–•","ğŸ©¹","ğŸ‘„","ğŸ‘š","ğŸ‚","ğŸ","ğŸš…","ğŸ‘³","ğŸ§‰","ğŸˆµ","â™’ï¸","ğŸ”Œ","ğŸ––","ğŸ“ƒ","ğŸš¹","ğŸ©","ğŸ—º","ğŸ•¸","ğŸ‡","ğŸ³","ğŸ¢","ğŸ“","ğŸ˜¼","ğŸ’‘","ğŸ","ğŸ–Œ","ğŸ›","ğŸ“¯","ğŸŒ’","ğŸ›¹","ğŸ‘œ","ğŸ‘","ğŸ›³","â™ˆï¸","â™Šï¸","â™ï¸","ğŸ¦‰","âš–ï¸","ğŸ¦°","ğŸ«","â›ªï¸","ğŸ†","ğŸ¤¼","â™¿ï¸","ğŸ—","ğŸŒ­","ğŸ‡¼","ğŸ§„","ğŸš","ğŸ¦•","ğŸŸª","ğŸ§©","ğŸ›’","ğŸ“¡","ğŸŸ¥","ğŸŸ¨","ğŸŒ","ğŸ¥ƒ","ğŸ“","ğŸ«","ğŸ”‹","ğŸ”†","ğŸ¥‰","ğŸ–¥","ğŸ•µ","ğŸ¤ ","ğŸ§›","ğŸ…","â¿","ğŸ©º","ğŸš†","ğŸŒ¬","ğŸ”Š","ğŸŒš","â›‘","ğŸ§¼","â›ˆ","ğŸ‘±","ğŸ›¡","ğŸ”¼","ğŸ““","ğŸ’†","â°","â†™ï¸","ğŸ”˜","ğŸ—","ğŸ…°ï¸","ğŸš‹","ğŸ–","ğŸ§”","ğŸ”«","ğŸ›‘","ğŸ¦±","ğŸ","ğŸ“³","ğŸŒ¡","ğŸš›","ğŸ¥¿","ğŸ»","ğŸ®","ğŸ“©","ğŸ¥ ","â«","â™Ÿ","ğŸ™‰","ğŸ¦´","ğŸ“„","ğŸ§º","ğŸ","ğŸ§¥","ğŸ›¥","â™‰ï¸","â™Œï¸","ğŸš¦","ğŸ§­","â²","â›²ï¸","ğŸ§","ğŸš‰","ğŸ€","ğŸ“€","ğŸ›°","ğŸ¿","ğŸŠ","ğŸŸ","âš°ï¸","ğŸ¤¹","ğŸƒ","ğŸˆ‚","ğŸ¼","ğŸ§","ğŸ¥¡","ğŸ”™","ğŸ“","ğŸ¥¾","ğŸ—‘","ğŸŸ§","ğŸ‹","ğŸš‡","ğŸ¦½","ğŸ©¸","ğŸ›","ğŸ‘","ğŸ“½","ğŸ‘™","ğŸ•","ğŸ¥„","â›","ğŸ—¯","ğŸ¦…","ğŸª“","ğŸ“®","ğŸ¹","ğŸ¦‚","ğŸ›","ğŸŒ¥","ğŸ§","ğŸ¦¡","ğŸ•¶","ğŸ†","ğŸ–‡","ğŸ¥","ğŸŒ¯","ğŸ§—","ğŸˆ","ğŸ¦","ğŸ”·","ğŸˆ¹","ğŸš§","ğŸ‘","ğŸ¦¹","ğŸ†™","ğŸ´","ğŸ’¶","ğŸ’·","ğŸ§†","ğŸ¦¾","â™ï¸","ğŸ“‘","ğŸ¤¡","ğŸ§","ğŸ¥‹","ğŸŒ¦","ğŸš”","ğŸ›‹","ğŸ§œ","ğŸ¤µ","ğŸ¦¸","ğŸ½","ğŸ›©","âšœï¸","ğŸ§«","ğŸ”’","ğŸ™","ğŸ¦—","ğŸ•’","â›±","ğŸŒ“","ğŸŒ—","ğŸŒ˜","ğŸ“¥","ğŸ”­ ã€½ï¸","ğŸ”","ğŸ•³","ğŸˆšï¸","ğŸš„","ğŸ‚","ğŸ‘˜","ğŸš­","ğŸ—½","â˜¸ï¸","ğŸš½","ğŸº","ğŸ–","ğŸ¿","ğŸ•™","â›½ï¸","ğŸ‡»","ğŸ¥™","â†©ï¸","ğŸ›¸","ğŸ¤’","ğŸ§µ","ğŸš°","ğŸ¤•","ğŸš","ğŸ“¢","ğŸª‚","ğŸ´","ğŸ¤","ğŸ¯","ğŸ‘¡","â†•ï¸","ğŸš®","ğŸ›¬","â","â†–ï¸","ğŸ§ª","ğŸ”ˆ","ğŸ“§","ğŸ“°","ğŸ†“"]


try:
    # ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—
    form = cgi.FieldStorage()

    try:
        fileitem = form['file_data']
        size=size_to_str(int(form['file_size'].value),2)
        
        if(fileitem.type=="image/jpeg" or fileitem.type=="image/png"):
            # jpegãƒ»pngç”»åƒã®å ´åˆâ†’ãã®ã¾ã¾é€ä¿¡
            bot = LINENotifyBot(access_token=os.environ.get('LINE_ACCESS_TOKEN'))
            bot.send(
                message="ç”»åƒãŒé€ä¿¡ã•ã‚Œã¾ã—ãŸ",
                image_row=fileitem.file.read(),
            )
        else:
            # ãã®ä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«â†’ã‚µãƒ¼ãƒãƒ¼ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¦URLã‚’é€ã‚‹
            # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆã¯æ–°è¦ä½œæˆ
            if not os.path.exists("upload"):
                os.makedirs("upload")  # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆï¼ˆã‚µãƒ–ãƒ•ã‚©ãƒ«ãƒ€ãƒ¼ã‚’æŒ‡å®šã™ã‚‹å ´åˆã¯ãƒ‘ã‚¹ã‚’ã€Œtmp/subã€ã®ã‚ˆã†ã«æŒ‡å®šã™ã‚‹ï¼‰

            # ç¾åœ¨ã®æ—¥æ™‚ã‚’å–å¾—
            dt_now = datetime.datetime.now()

            # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ»ãƒ•ã‚¡ã‚¤ãƒ«åéƒ¨åˆ†,æ‹¡å¼µå­éƒ¨åˆ†ï¼ˆ.ï½ï¼‰
            fn_split = os.path.splitext(str(fileitem.filename))

            savename=fn_split[0]+"_"+dt_now.strftime('%Y%m%d%H%M%S')+fn_split[1]
            savename_long =  os.path.join("upload", savename) # uploadãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã«ä¿å­˜

            # ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã‚’æ›¸ãè¾¼ã¿
            if fileitem.file:
                file_write = open(savename_long, 'wb')
                while True:
                    chunk = fileitem.file.read(1000000)
                    if not chunk:
                        break
                    file_write.write(chunk)
                file_write.close()

            # æ¨©é™å¤‰æ›´ï¼ˆURLã«ã‚ˆã‚‹ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã‚’ç¦æ­¢ï¼‰       
            os.chmod(savename_long,0o600)

            # url = "https://rabbitprogram.com/python3.8.6/line/groupsend/"+urllib.parse.quote(savename_long)
            downloadurl="https://rabbitprogram.com/python3.8.6/line/groupsend/download.py" \
                +"?type="+urllib.parse.quote(fileitem.type) \
                +"&uri="+urllib.parse.quote(savename) \
                +"&name="+urllib.parse.quote(fileitem.filename)
            
            # URLçŸ­ç¸®
            response = requests.get("https://is.gd/create.php?format=simple&format=json&url="+urllib.parse.quote(downloadurl))
            jsondata=json.loads(response.text)
            downloadurl=jsondata["shorturl"]

            # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æœŸé™ã‚’ç®—å‡º
            today=datetime.datetime.now()
            enddate = today + datetime.timedelta(weeks=1)  # 1é€±é–“å¾Œ

            # LINE Notifyã§é€ä¿¡
            bot = LINENotifyBot(access_token=os.environ.get('LINE_ACCESS_TOKEN'))
            bot.send(
                message="ã€ ãƒ•ã‚¡ã‚¤ãƒ«ãŒé€ä¿¡ã•ã‚Œã¾ã—ãŸ ã€‘\nãƒ»ãƒ•ã‚¡ã‚¤ãƒ«åï¼š"+fileitem.filename \
                    +"\nãƒ»ã‚µã‚¤ã‚ºï¼š"+size \
                    +"\nãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLï¼š"+downloadurl \
                    +"\nãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æœŸé™ï¼š"+enddate.strftime("%Y/%m/%d")+"ã¾ã§",
            )
    except Exception as e:
        # æ–‡å­—åˆ—ãŒç©ºã®å ´åˆã¯çµµæ–‡å­—ã‚’é€ã‚‹
        sendtext = str(form.getvalue('text', ''))
        if(len(sendtext)==0):
            for i in range(10):
                index=random.randint(0, len(emoji)-1)
                sendtext=sendtext+emoji[index]

        # # ãƒ–ãƒ©ã‚¦ã‚¶ãƒ»OSæƒ…å ±ã‚’å–å¾—
        # try:
        #     r_HTTP_USER_AGENT = os.environ['HTTP_USER_AGENT']
        # except:
        #     r_HTTP_USER_AGENT="ä¸æ˜"

        # # IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—
        # try:
        #     r_REMOTE_ADDR = os.environ['REMOTE_ADDR']
        # except :
        #     r_REMOTE_ADDR="ä¸æ˜"
        
        # # IPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå–å¾—ã§ããŸå ´åˆã¯è©³ç´°ã‚‚èª¿ã¹ã‚‹
        # addtext=""
        # if(r_REMOTE_ADDR!="ä¸æ˜"):
        #     geo_r= geolite2.reader()
        #     res = geo_r.get(r_REMOTE_ADDR)
        #     addtext="\nåœ°åŸŸï¼š"+res["country"]["names"]["ja"]+" , "+res["city"]["names"]["ja"]
        #     addtext=addtext+"\nGoogleãƒãƒƒãƒ—ã§é–‹ãï¼š"+"https://www.google.com/maps?q="+str(res["location"]["latitude"])+","+str(res["location"]["longitude"])

        # LINE Notifyã§é€ä¿¡
        bot = LINENotifyBot(access_token=os.environ.get('LINE_ACCESS_TOKEN'))
        bot.send(
            message="\n"+sendtext,
            # message="\n"+sendtext+"\n\né€ä¿¡ç«¯æœ«æƒ…å ±\n"+r_HTTP_USER_AGENT+"\n\nIPã‚¢ãƒ‰ãƒ¬ã‚¹\n"+r_REMOTE_ADDR+addtext,
            # ã‚¹ã‚¿ãƒ³ãƒ—ã‚’é€ä¿¡ã™ã‚‹å ´åˆ
            # sticker_package_id=1,
            # sticker_id=13,
        )
    
    # ãƒšãƒ¼ã‚¸è¡¨ç¤º
    print('Content-type:text/plain')
    print('')  # ç©ºç™½è¡Œã¯ã€ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’çµ‚äº†ã™ã‚‹ã‚ˆã†ã«ã‚µãƒ¼ãƒãƒ¼ã«æŒ‡ç¤ºã—ã¾ã™
    print("ok")

except Exception as e:
    print('Content-type:text/plain')
    print('')  # ç©ºç™½è¡Œã¯ã€ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’çµ‚äº†ã™ã‚‹ã‚ˆã†ã«ã‚µãƒ¼ãƒãƒ¼ã«æŒ‡ç¤ºã—ã¾ã™
    print("error:",e)
